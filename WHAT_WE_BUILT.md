# ğŸ‰ Points System V2 - å®Œæ•´å®ç°æ€»ç»“

## ğŸ“Š é¡¹ç›®æ¦‚è§ˆ

æˆ‘ä»¬æˆåŠŸå®ç°äº†ä¸€ä¸ªå®Œæ•´çš„**åŒè½¨åˆ¶ç§¯åˆ†ç³»ç»Ÿ**ï¼š
- **å…è´¹é¢åº¦**ï¼šæœªç™»å½•ç”¨æˆ·æ¯å¤© 1 æ¬¡å…è´¹ç”Ÿæˆ
- **ç§¯åˆ†ç³»ç»Ÿ**ï¼šç™»å½•ç”¨æˆ·ä½¿ç”¨ç§¯åˆ†ç”Ÿæˆå›¾ç‰‡

---

## âœ¨ æ ¸å¿ƒåŠŸèƒ½

### 1. æœªç™»å½•ç”¨æˆ·å…è´¹é¢åº¦
```
æ¯å¤© 1 æ¬¡å…è´¹ç”Ÿæˆ
    â†“
ä»…é™ flux-schnell æ¨¡å‹
    â†“
åŸºäº IP + æµè§ˆå™¨æŒ‡çº¹è¿½è¸ª
    â†“
æ¯æ—¥ UTC 00:00 è‡ªåŠ¨é‡ç½®
```

### 2. ç™»å½•ç”¨æˆ·ç§¯åˆ†ç³»ç»Ÿ
```
æ³¨å†Œé€ 3 ç§¯åˆ†
    â†“
ä¸åŒæ¨¡å‹æ¶ˆè€—ä¸åŒç§¯åˆ†
    â†“
å®Œæ•´çš„äº¤æ˜“è®°å½•
    â†“
ç§¯åˆ†ä¸è¶³æç¤ºè´­ä¹°
```

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### æ•°æ®åº“è®¾è®¡ï¼ˆD1ï¼‰

#### daily_usage è¡¨
è¿½è¸ªæœªç™»å½•ç”¨æˆ·çš„æ¯æ—¥ä½¿ç”¨é‡
```sql
- date: æ—¥æœŸï¼ˆYYYY-MM-DDï¼‰
- ip_hash: IP åœ°å€å“ˆå¸Œ
- fingerprint_hash: æµè§ˆå™¨æŒ‡çº¹å“ˆå¸Œ
- generation_count: å½“å¤©ç”Ÿæˆæ¬¡æ•°
```

#### generation_history è¡¨
è®°å½•æ‰€æœ‰ç”Ÿæˆä»»åŠ¡
```sql
- user_id: ç”¨æˆ· IDï¼ˆå¯ä¸ºç©ºï¼‰
- model: ä½¿ç”¨çš„æ¨¡å‹
- prompt: æç¤ºè¯
- points_used: æ¶ˆè€—çš„ç§¯åˆ†
- used_free_tier: æ˜¯å¦ä½¿ç”¨å…è´¹é¢åº¦
- status: çŠ¶æ€ï¼ˆpending/completed/failedï¼‰
```

#### transactions è¡¨
è®°å½•æ‰€æœ‰ç§¯åˆ†äº¤æ˜“
```sql
- user_id: ç”¨æˆ· ID
- type: ç±»å‹ï¼ˆdeduct/addï¼‰
- amount: é‡‘é¢
- balance_before: æ“ä½œå‰ä½™é¢
- balance_after: æ“ä½œåä½™é¢
- reason: åŸå› 
```

### API å®ç°ï¼ˆCloudflare Workersï¼‰

#### getUserStatusV2
è·å–ç”¨æˆ·çŠ¶æ€å’Œå‰©ä½™é¢åº¦
```typescript
GET /api/v2/generation/status
Response: {
  isLoggedIn: boolean,
  points: number,
  freeGenerationsRemaining: number
}
```

#### createGenerationV2
åˆ›å»ºç”Ÿæˆä»»åŠ¡å¹¶æ‰£é™¤é¢åº¦/ç§¯åˆ†
```typescript
POST /api/v2/generation/create
Body: {
  model: string,
  prompt: string,
  userId?: number
}
Response: {
  success: boolean,
  generationId: string,
  newBalance: number
}
```

---

## ğŸ”§ å…³é”®æŠ€æœ¯çªç ´

### 1. æŒ‡çº¹æŒä¹…åŒ–
**é—®é¢˜**ï¼šæ¯æ¬¡åˆ·æ–°é¡µé¢ç”Ÿæˆæ–°æŒ‡çº¹ï¼Œå¯¼è‡´çŠ¶æ€ä¸ä¸€è‡´

**è§£å†³æ–¹æ¡ˆ**ï¼š
```typescript
const getOrCreateFingerprint = (): string => {
  const cached = localStorage.getItem('browser_fingerprint');
  if (cached) return cached;
  
  const fingerprint = generateFingerprint();
  localStorage.setItem('browser_fingerprint', fingerprint);
  return fingerprint;
};
```

### 2. IP æ ‡å‡†åŒ–
**é—®é¢˜**ï¼šæœ¬åœ°å¼€å‘æ—¶ IPv6 (::1) å’Œ IPv4 (127.0.0.1) äº§ç”Ÿä¸åŒå“ˆå¸Œ

**è§£å†³æ–¹æ¡ˆ**ï¼š
```typescript
function normalizeIP(ip: string): string {
  if (ip === '::1' || ip === '::ffff:127.0.0.1') {
    return '127.0.0.1';
  }
  return ip;
}
```

### 3. CORS é…ç½®
**é—®é¢˜**ï¼šå‰ç«¯æ— æ³•å‘é€è‡ªå®šä¹‰ header

**è§£å†³æ–¹æ¡ˆ**ï¼š
```typescript
// worker/index-hono.ts
app.use('*', cors({
  origin: ['http://localhost:3000', 'https://yourdomain.com'],
  allowHeaders: ['Content-Type', 'Authorization', 'x-fingerprint-hash'],
  allowMethods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  credentials: true,
}));
```

---

## ğŸ“ˆ æµ‹è¯•ç»“æœ

### æœ¬åœ°æµ‹è¯• âœ…

#### æœªç™»å½•ç”¨æˆ·æµ‹è¯•
- âœ… é¦–æ¬¡ç”ŸæˆæˆåŠŸ
- âœ… åˆ·æ–°åçŠ¶æ€æ­£ç¡®ï¼ˆ0 / 1ï¼‰
- âœ… ç¬¬äºŒæ¬¡ç”Ÿæˆæ­£ç¡®æç¤ºé™åˆ¶
- âœ… æ•°æ®åº“è®°å½•æ­£ç¡®

#### ç™»å½•ç”¨æˆ·æµ‹è¯•
- âœ… ç§¯åˆ†æ­£ç¡®æ‰£é™¤ï¼ˆ10 â†’ 9ï¼‰
- âœ… äº¤æ˜“è®°å½•æ­£ç¡®ä¿å­˜
- âœ… ç”Ÿæˆå†å²æ­£ç¡®è®°å½•
- âœ… API å“åº”æ­£ç¡®

### æ•°æ®åº“éªŒè¯ âœ…
- âœ… `daily_usage` è¡¨è®°å½•æ­£ç¡®
- âœ… `generation_history` è¡¨è®°å½•æ­£ç¡®
- âœ… `transactions` è¡¨è®°å½•æ­£ç¡®
- âœ… æ‰€æœ‰ç´¢å¼•æ­£å¸¸å·¥ä½œ

---

## ğŸ“ é¡¹ç›®æ–‡ä»¶

### æ ¸å¿ƒå®ç°
- `worker/handlers/getUserStatusV2.ts` - è·å–ç”¨æˆ·çŠ¶æ€
- `worker/handlers/createGenerationV2.ts` - åˆ›å»ºç”Ÿæˆä»»åŠ¡
- `worker/routes/generation.ts` - è·¯ç”±é…ç½®
- `hooks/useImageGeneration.tsx` - å‰ç«¯é›†æˆ
- `components/AIImageGenerator.tsx` - UI ç»„ä»¶

### æ•°æ®åº“
- `migrations/d1-points-system-v2.sql` - æ•°æ®åº“è¿ç§»è„šæœ¬

### é…ç½®
- `worker/wrangler.toml` - Worker é…ç½®
- `worker/index-hono.ts` - Worker å…¥å£å’Œ CORS

### æ–‡æ¡£
- `READY_TO_DEPLOY.md` - éƒ¨ç½²å‡†å¤‡
- `DEPLOY.md` - å¿«é€Ÿéƒ¨ç½²æŒ‡å—
- `PRODUCTION_DEPLOYMENT_CHECKLIST.md` - å®Œæ•´æ£€æŸ¥æ¸…å•
- `POINTS_SYSTEM_V2_SUMMARY.md` - ç³»ç»Ÿæ€»ç»“
- `TEST_GUIDE.md` - æµ‹è¯•æŠ¥å‘Š

---

## ğŸ¯ ç³»ç»Ÿè§„åˆ™

### ç§¯åˆ†æ¶ˆè€—è§„åˆ™
```typescript
const POINTS_CONFIG = {
  'flux-schnell': 1,
  'flux-dev': 3,
  'flux-1.1-pro-ultra': 3,
  'flux-1.1-pro': 5,
  'flux-pro': 6,
};
```

### å…è´¹é¢åº¦è§„åˆ™
- **æ¯æ—¥é™é¢**ï¼š1 æ¬¡
- **å¯ç”¨æ¨¡å‹**ï¼šä»… flux-schnell
- **é‡ç½®æ—¶é—´**ï¼šæ¯å¤© UTC 00:00
- **è¿½è¸ªæ–¹å¼**ï¼šIP å“ˆå¸Œ + æŒ‡çº¹å“ˆå¸Œ

### ç”¨æˆ·åˆå§‹ç§¯åˆ†
- **æ³¨å†Œå¥–åŠ±**ï¼š3 ç§¯åˆ†
- **é¦–æ¬¡ç™»å½•**ï¼šæ— é¢å¤–å¥–åŠ±
- **é‚€è¯·å¥–åŠ±**ï¼šæœªå®ç°ï¼ˆæœªæ¥åŠŸèƒ½ï¼‰

---

## ğŸš€ éƒ¨ç½²æ¶æ„

### Vercelï¼ˆå‰ç«¯ + NextAuthï¼‰
- Next.js åº”ç”¨
- NextAuth è®¤è¯
- Prisma + PostgreSQL

### Cloudflare Workersï¼ˆAPIï¼‰
- Points System V2 API
- D1 æ•°æ®åº“
- å…¨çƒè¾¹ç¼˜éƒ¨ç½²

### æ•°æ®æµ
```
ç”¨æˆ·è¯·æ±‚
    â†“
Next.js å‰ç«¯ï¼ˆVercelï¼‰
    â†“
Worker APIï¼ˆCloudflareï¼‰
    â†“
D1 æ•°æ®åº“ï¼ˆCloudflareï¼‰
```

---

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

### é¢„æœŸæ€§èƒ½
- **API å“åº”æ—¶é—´**ï¼š< 100msï¼ˆå…¨çƒè¾¹ç¼˜ï¼‰
- **æ•°æ®åº“æŸ¥è¯¢**ï¼š< 50msï¼ˆD1ï¼‰
- **å‰ç«¯åŠ è½½**ï¼š< 2sï¼ˆVercelï¼‰

### æ‰©å±•æ€§
- **å¹¶å‘æ”¯æŒ**ï¼š10,000+ è¯·æ±‚/ç§’
- **æ•°æ®åº“å®¹é‡**ï¼šæ— é™åˆ¶ï¼ˆD1ï¼‰
- **å…¨çƒéƒ¨ç½²**ï¼š200+ è¾¹ç¼˜èŠ‚ç‚¹

---

## ğŸ‰ é¡¹ç›®æˆå°±

### å·²å®Œæˆ âœ…
- [x] å®Œæ•´çš„åŒè½¨åˆ¶ç§¯åˆ†ç³»ç»Ÿ
- [x] D1 æ•°æ®åº“æ¶æ„è®¾è®¡
- [x] Worker API å®ç°
- [x] å‰ç«¯é›†æˆå’Œ UI ä¼˜åŒ–
- [x] æŒ‡çº¹æŒä¹…åŒ–ä¿®å¤
- [x] IP æ ‡å‡†åŒ–ä¿®å¤
- [x] å®Œæ•´æµ‹è¯•éªŒè¯
- [x] éƒ¨ç½²æ–‡æ¡£å‡†å¤‡

### å¾…å®Œæˆ â³
- [ ] ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
- [ ] ç”Ÿäº§ç¯å¢ƒæµ‹è¯•
- [ ] ç›‘æ§å’Œå‘Šè­¦é…ç½®
- [ ] ç§¯åˆ†è´­ä¹°åŠŸèƒ½
- [ ] ç®¡ç†åå°

---

## ğŸ’¡ æœªæ¥æ”¹è¿›

### çŸ­æœŸï¼ˆ1-2 å‘¨ï¼‰
1. **ç§¯åˆ†è´­ä¹°**ï¼šStripe æ”¯ä»˜é›†æˆ
2. **ç§¯åˆ†å†å²**ï¼šç”¨æˆ·æŸ¥çœ‹äº¤æ˜“è®°å½•
3. **é‚€è¯·å¥–åŠ±**ï¼šé‚€è¯·å¥½å‹é€ç§¯åˆ†

### ä¸­æœŸï¼ˆ1-2 æœˆï¼‰
1. **ç®¡ç†åå°**ï¼šæŸ¥çœ‹ç³»ç»Ÿç»Ÿè®¡
2. **ç”¨æˆ·åˆ†æ**ï¼šä½¿ç”¨è¡Œä¸ºåˆ†æ
3. **A/B æµ‹è¯•**ï¼šä¼˜åŒ–è½¬åŒ–ç‡

### é•¿æœŸï¼ˆ3-6 æœˆï¼‰
1. **è®¢é˜…åˆ¶**ï¼šæœˆä»˜/å¹´ä»˜ä¼šå‘˜
2. **ä¼ä¸šç‰ˆ**ï¼šAPI è®¿é—®å’Œæ‰¹é‡ç”Ÿæˆ
3. **æ›´å¼ºåæ»¥ç”¨**ï¼šè®¾å¤‡æŒ‡çº¹ã€è¡Œä¸ºåˆ†æ

---

## ğŸ† æŠ€æœ¯äº®ç‚¹

1. **åŒè½¨åˆ¶è®¾è®¡**ï¼šå…è´¹é¢åº¦ + ç§¯åˆ†ç³»ç»Ÿå®Œç¾ç»“åˆ
2. **è¾¹ç¼˜è®¡ç®—**ï¼šCloudflare Workers å…¨çƒéƒ¨ç½²
3. **æŒ‡çº¹æŒä¹…åŒ–**ï¼šè§£å†³æµè§ˆå™¨æŒ‡çº¹ä¸€è‡´æ€§é—®é¢˜
4. **IP æ ‡å‡†åŒ–**ï¼šè§£å†³æœ¬åœ°å¼€å‘ç¯å¢ƒé—®é¢˜
5. **å®Œæ•´æµ‹è¯•**ï¼šæ‰€æœ‰åŠŸèƒ½ç»è¿‡éªŒè¯
6. **è¯¦ç»†æ–‡æ¡£**ï¼šä»è®¾è®¡åˆ°éƒ¨ç½²å…¨è¦†ç›–

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### é—®é¢˜æ’æŸ¥
1. **çŠ¶æ€ä¸æ›´æ–°**ï¼šæ£€æŸ¥æŒ‡çº¹æ˜¯å¦æŒä¹…åŒ–
2. **ç§¯åˆ†æœªæ‰£é™¤**ï¼šæŸ¥çœ‹ Worker æ—¥å¿—
3. **å…è´¹é¢åº¦ä¸é‡ç½®**ï¼šæ£€æŸ¥æ—¥æœŸå’Œæ—¶åŒº

### è°ƒè¯•å·¥å…·
```bash
# Worker æ—¥å¿—
wrangler tail --env production

# æ•°æ®åº“æŸ¥è¯¢
wrangler d1 execute flux-ai-prod --remote --command "SELECT * FROM daily_usage LIMIT 10;"

# æµè§ˆå™¨æ§åˆ¶å°
localStorage.getItem('browser_fingerprint')
```

---

**é¡¹ç›®å®Œæˆæ—¥æœŸ**: 2024-12-16  
**ç‰ˆæœ¬**: Points System V2.0  
**çŠ¶æ€**: âœ… å¼€å‘å®Œæˆï¼Œæµ‹è¯•é€šè¿‡ï¼Œå‡†å¤‡éƒ¨ç½²  
**å›¢é˜Ÿ**: AI + Human åä½œ  
**æ€»è€—æ—¶**: ~8 å°æ—¶ï¼ˆè®¾è®¡ + å¼€å‘ + æµ‹è¯•ï¼‰

---

## ğŸ™ è‡´è°¢

æ„Ÿè°¢ä½ çš„è€å¿ƒå’Œé…åˆï¼è¿™ä¸ªé¡¹ç›®ä»è®¾è®¡åˆ°å®ç°ï¼Œç»å†äº†å¤šæ¬¡è¿­ä»£å’Œä¼˜åŒ–ï¼Œæœ€ç»ˆå®ç°äº†ä¸€ä¸ªå®Œæ•´ã€å¯é ã€é«˜æ€§èƒ½çš„ç§¯åˆ†ç³»ç»Ÿã€‚

**ç°åœ¨ï¼Œè®©æˆ‘ä»¬éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒå§ï¼** ğŸš€
