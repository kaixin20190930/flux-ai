# Points System V2 å®Œæˆæ€»ç»“

## âœ… å·²å®Œæˆçš„åŠŸèƒ½

### 1. æ ¸å¿ƒç³»ç»Ÿè®¾è®¡
- **å…è´¹é¢åº¦ç³»ç»Ÿ**ï¼šæœªç™»å½•ç”¨æˆ·æ¯å¤© 1 æ¬¡å…è´¹ç”Ÿæˆï¼ˆä»… flux-schnellï¼‰
- **ç§¯åˆ†ç³»ç»Ÿ**ï¼šç™»å½•ç”¨æˆ·ä½¿ç”¨ç§¯åˆ†ç”Ÿæˆå›¾ç‰‡
- **æ•°æ®åº“è®¾è®¡**ï¼šD1 æ•°æ®åº“ï¼ŒåŒ…å« `daily_usage`ã€`generation_history`ã€`transactions` è¡¨

### 2. æŠ€æœ¯å®ç°
- **æŒ‡çº¹æŒä¹…åŒ–**ï¼šä½¿ç”¨ `localStorage` ç¼“å­˜æµè§ˆå™¨æŒ‡çº¹ï¼Œç¡®ä¿ä¸€è‡´æ€§
- **IP æ ‡å‡†åŒ–**ï¼šå°† IPv6 (`::1`) ç»Ÿä¸€è½¬æ¢ä¸º IPv4 (`127.0.0.1`)ï¼Œè§£å†³æœ¬åœ°å¼€å‘ç¯å¢ƒçš„å“ˆå¸Œä¸ä¸€è‡´é—®é¢˜
- **Worker API**ï¼šå®Œæ•´çš„ V2 handlersï¼ˆ`getUserStatusV2.ts`ã€`createGenerationV2.ts`ï¼‰
- **å‰ç«¯é›†æˆ**ï¼š`useImageGeneration.tsx` hook å®Œæ•´æ”¯æŒæ–°ç³»ç»Ÿ

### 3. æµ‹è¯•éªŒè¯
- âœ… å…è´¹é¢åº¦æ­£ç¡®æ‰£é™¤
- âœ… åˆ·æ–°é¡µé¢çŠ¶æ€ä¿æŒæ­£ç¡®
- âœ… ç™»å½•ç”¨æˆ·ç§¯åˆ†æ­£ç¡®æ‰£é™¤
- âœ… äº¤æ˜“è®°å½•æ­£ç¡®ä¿å­˜
- âœ… ç”Ÿæˆå†å²æ­£ç¡®è®°å½•
- âœ… ç§¯åˆ†ä¸è¶³æ—¶æ­£ç¡®æç¤º

---

## ğŸ“Š ç³»ç»Ÿè§„åˆ™

### æœªç™»å½•ç”¨æˆ·
- **å…è´¹é¢åº¦**ï¼šæ¯å¤© 1 æ¬¡
- **å¯ç”¨æ¨¡å‹**ï¼šä»… flux-schnell
- **è¿½è¸ªæ–¹å¼**ï¼šIP å“ˆå¸Œ + æµè§ˆå™¨æŒ‡çº¹å“ˆå¸Œ
- **é™åˆ¶æç¤º**ï¼šè¾¾åˆ°é™åˆ¶åæç¤ºç™»å½•

### ç™»å½•ç”¨æˆ·
- **åˆå§‹ç§¯åˆ†**ï¼šæ³¨å†Œæ—¶è·å¾— 3 ç§¯åˆ†
- **ç§¯åˆ†æ¶ˆè€—**ï¼š
  - flux-schnell: 1 ç§¯åˆ†
  - flux-dev: 3 ç§¯åˆ†
  - flux-1.1-pro-ultra: 3 ç§¯åˆ†
  - flux-1.1-pro: 5 ç§¯åˆ†
  - flux-pro: 6 ç§¯åˆ†
- **ç§¯åˆ†ä¸è¶³**ï¼šæç¤ºè´­ä¹°ç§¯åˆ†

---

## ğŸ—„ï¸ æ•°æ®åº“ç»“æ„

### daily_usage è¡¨
```sql
- id: å”¯ä¸€æ ‡è¯†
- date: æ—¥æœŸï¼ˆYYYY-MM-DDï¼‰
- ip_hash: IP åœ°å€å“ˆå¸Œ
- fingerprint_hash: æµè§ˆå™¨æŒ‡çº¹å“ˆå¸Œ
- generation_count: å½“å¤©ç”Ÿæˆæ¬¡æ•°
- created_at, updated_at: æ—¶é—´æˆ³
```

### generation_history è¡¨
```sql
- id: ç”Ÿæˆä»»åŠ¡ ID
- user_id: ç”¨æˆ· IDï¼ˆå¯ä¸ºç©ºï¼‰
- model: ä½¿ç”¨çš„æ¨¡å‹
- prompt: æç¤ºè¯
- points_used: æ¶ˆè€—çš„ç§¯åˆ†
- used_free_tier: æ˜¯å¦ä½¿ç”¨å…è´¹é¢åº¦
- ip_address: IP åœ°å€
- fingerprint_hash: æŒ‡çº¹å“ˆå¸Œ
- status: çŠ¶æ€ï¼ˆpending/completed/failedï¼‰
- created_at, completed_at: æ—¶é—´æˆ³
```

### transactions è¡¨
```sql
- id: äº¤æ˜“ ID
- user_id: ç”¨æˆ· ID
- type: ç±»å‹ï¼ˆdeduct/addï¼‰
- amount: é‡‘é¢
- balance_before: æ“ä½œå‰ä½™é¢
- balance_after: æ“ä½œåä½™é¢
- reason: åŸå› 
- generation_id: å…³è”çš„ç”Ÿæˆä»»åŠ¡ ID
- created_at: æ—¶é—´æˆ³
```

---

## ğŸ”§ å…³é”®æŠ€æœ¯ç»†èŠ‚

### 1. IP æ ‡å‡†åŒ–
```typescript
function normalizeIP(ip: string): string {
  if (ip === '::1' || ip === '::ffff:127.0.0.1') {
    return '127.0.0.1';
  }
  return ip;
}
```

**ä½œç”¨**ï¼šç¡®ä¿æœ¬åœ°å¼€å‘æ—¶ IPv6 å’Œ IPv4 åœ°å€äº§ç”Ÿç›¸åŒçš„å“ˆå¸Œå€¼

### 2. æŒ‡çº¹æŒä¹…åŒ–
```typescript
const getOrCreateFingerprint = (): string => {
  const cached = localStorage.getItem('browser_fingerprint');
  if (cached) return cached;
  
  const fingerprint = `${nav.userAgent}-${nav.language}-${screen.colorDepth}-${screen.width}x${screen.height}`;
  const hash = btoa(fingerprint).substring(0, 32);
  
  localStorage.setItem('browser_fingerprint', hash);
  return hash;
};
```

**ä½œç”¨**ï¼šç¡®ä¿åŒä¸€æµè§ˆå™¨æ¯æ¬¡ç”Ÿæˆç›¸åŒçš„æŒ‡çº¹å“ˆå¸Œ

### 3. æ•°æ®åº“æŸ¥è¯¢é€»è¾‘
```typescript
// æŸ¥è¯¢ä»Šæ—¥ä½¿ç”¨æ¬¡æ•°
const usage = await db.prepare(`
  SELECT generation_count FROM daily_usage
  WHERE date = ? AND ip_hash = ? AND fingerprint_hash = ?
`).bind(today, ipHash, fingerprintHash).first();

const usedCount = usage?.generation_count || 0;
const freeGenerationsRemaining = Math.max(0, 1 - usedCount);
```

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

### Worker åç«¯
- `worker/handlers/getUserStatusV2.ts` - è·å–ç”¨æˆ·çŠ¶æ€
- `worker/handlers/createGenerationV2.ts` - åˆ›å»ºç”Ÿæˆä»»åŠ¡
- `worker/routes/generation.ts` - è·¯ç”±é…ç½®
- `worker/index-hono.ts` - CORS é…ç½®
- `worker/wrangler.toml` - KV é…ç½®ä¿®å¤

### å‰ç«¯
- `hooks/useImageGeneration.tsx` - æŒ‡çº¹æŒä¹…åŒ–
- `components/AIImageGenerator.tsx` - UI ä¼˜åŒ–ï¼ˆæ³¨å†Œæ¿€åŠ±æµ®åŠ¨å¡ç‰‡ï¼‰

### æ•°æ®åº“
- `migrations/d1-points-system-v2.sql` - æ•°æ®åº“è¿ç§»è„šæœ¬

---

## ğŸš€ éƒ¨ç½²å‡†å¤‡

### æœ¬åœ°æµ‹è¯•å®Œæˆ âœ…
- å…è´¹é¢åº¦ç³»ç»Ÿæµ‹è¯•é€šè¿‡
- ç™»å½•ç”¨æˆ·ç§¯åˆ†æ‰£é™¤æµ‹è¯•é€šè¿‡
- IP æ ‡å‡†åŒ–æµ‹è¯•é€šè¿‡
- æŒ‡çº¹æŒä¹…åŒ–æµ‹è¯•é€šè¿‡

### ç”Ÿäº§éƒ¨ç½²å¾…åŠ
1. **æ•°æ®åº“è¿ç§»**
   - åœ¨ç”Ÿäº§ D1 æ•°æ®åº“è¿è¡Œè¿ç§»è„šæœ¬
   - éªŒè¯è¡¨ç»“æ„æ­£ç¡®

2. **ç¯å¢ƒå˜é‡é…ç½®**
   - `JWT_SECRET` - JWT å¯†é’¥
   - `IP_SALT` - IP å“ˆå¸Œç›å€¼
   - å…¶ä»–å¿…éœ€çš„ç¯å¢ƒå˜é‡

3. **Worker éƒ¨ç½²**
   - éƒ¨ç½²åˆ° Cloudflare Workers
   - é…ç½®è‡ªå®šä¹‰åŸŸå
   - æµ‹è¯• API ç«¯ç‚¹

4. **å‰ç«¯éƒ¨ç½²**
   - æ›´æ–° `WORKER_URL` ç¯å¢ƒå˜é‡
   - éƒ¨ç½²åˆ° Vercel
   - æµ‹è¯•å®Œæ•´æµç¨‹

---

## ğŸ“ å·²çŸ¥é™åˆ¶å’Œæœªæ¥æ”¹è¿›

### å½“å‰é™åˆ¶
1. **å…è´¹é¢åº¦é‡ç½®**ï¼šåŸºäºæ—¥æœŸï¼Œæ¯å¤© UTC 00:00 é‡ç½®
2. **æŒ‡çº¹è¿½è¸ª**ï¼šå¯èƒ½è¢«éšç§å·¥å…·ç»•è¿‡
3. **IP è¿½è¸ª**ï¼šVPN ç”¨æˆ·å¯èƒ½ç»•è¿‡é™åˆ¶

### æœªæ¥æ”¹è¿›
1. **æ³¨å†Œé€ç§¯åˆ†**ï¼šè‡ªåŠ¨åŒ–æµ‹è¯•å’ŒéªŒè¯
2. **ç§¯åˆ†è´­ä¹°**ï¼šStripe æ”¯ä»˜é›†æˆ
3. **ç§¯åˆ†å†å²**ï¼šç”¨æˆ·æŸ¥çœ‹ç§¯åˆ†ä½¿ç”¨è®°å½•
4. **ç®¡ç†åå°**ï¼šæŸ¥çœ‹ç³»ç»Ÿç»Ÿè®¡å’Œç”¨æˆ·æ•°æ®
5. **æ›´å¼ºçš„åæ»¥ç”¨**ï¼šè®¾å¤‡æŒ‡çº¹ã€è¡Œä¸ºåˆ†æ

---

## ğŸ¯ æˆåŠŸæ ‡å‡†

### å·²è¾¾æˆ âœ…
- [x] å…è´¹é¢åº¦ç³»ç»Ÿæ­£å¸¸å·¥ä½œ
- [x] ç™»å½•ç”¨æˆ·ç§¯åˆ†æ­£ç¡®æ‰£é™¤
- [x] åˆ·æ–°é¡µé¢çŠ¶æ€ä¿æŒæ­£ç¡®
- [x] äº¤æ˜“è®°å½•æ­£ç¡®ä¿å­˜
- [x] ç”Ÿæˆå†å²æ­£ç¡®è®°å½•
- [x] æ•°æ®åº“è®¾è®¡å®Œæ•´
- [x] å‰ç«¯ UI ä¼˜åŒ–å®Œæˆ

### å¾…éªŒè¯ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
- [ ] çœŸå®ç”¨æˆ·æ³¨å†Œæµç¨‹
- [ ] å¤§è§„æ¨¡å¹¶å‘æµ‹è¯•
- [ ] è·¨æ—¶åŒºæ—¥æœŸé‡ç½®
- [ ] æ€§èƒ½å’Œå“åº”æ—¶é—´

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### è°ƒè¯•å·¥å…·
- Worker æ—¥å¿—ï¼šæŸ¥çœ‹ Cloudflare Workers æ—¥å¿—
- æ•°æ®åº“æŸ¥è¯¢ï¼šä½¿ç”¨ `wrangler d1 execute` å‘½ä»¤
- æµè§ˆå™¨æ§åˆ¶å°ï¼šæŸ¥çœ‹æŒ‡çº¹å’Œ API è°ƒç”¨

### å¸¸è§é—®é¢˜
1. **çŠ¶æ€ä¸æ›´æ–°**ï¼šæ£€æŸ¥æŒ‡çº¹æ˜¯å¦ä¸€è‡´
2. **ç§¯åˆ†æœªæ‰£é™¤**ï¼šæ£€æŸ¥ Worker æ—¥å¿—å’Œæ•°æ®åº“
3. **å…è´¹é¢åº¦ä¸é‡ç½®**ï¼šæ£€æŸ¥æ—¥æœŸå’Œæ—¶åŒºè®¾ç½®

---

**å®Œæˆæ—¥æœŸ**ï¼š2024-12-16  
**ç‰ˆæœ¬**ï¼šPoints System V2.0  
**çŠ¶æ€**ï¼šâœ… å¼€å‘å®Œæˆï¼Œæµ‹è¯•é€šè¿‡ï¼Œå‡†å¤‡éƒ¨ç½²
