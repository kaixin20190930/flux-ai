# Cloudflare-First æ¶æ„è§„èŒƒ

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

**æœ¬é¡¹ç›®é‡‡ç”¨ 100% Cloudflare åŸç”Ÿéƒ¨ç½²æ¶æ„**ï¼Œå……åˆ†åˆ©ç”¨ Cloudflare çš„å…¨çƒè¾¹ç¼˜ç½‘ç»œå’ŒæœåŠ¡ç”Ÿæ€ã€‚

---

## ğŸ“‹ æ¶æ„å†³ç­–

### å®Œå…¨ Cloudflare éƒ¨ç½²

```
ç”¨æˆ·è¯·æ±‚
    â†“
Cloudflare CDNï¼ˆå…¨çƒè¾¹ç¼˜èŠ‚ç‚¹ï¼‰
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Cloudflare Pagesï¼ˆå‰ç«¯ï¼‰         â”‚
â”‚  - Next.js é™æ€é¡µé¢                  â”‚
â”‚  - SSR with Pages Functions         â”‚
â”‚  - å¤šè¯­è¨€è·¯ç”±                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Cloudflare Workersï¼ˆAPI å±‚ï¼‰       â”‚
â”‚  - Hono æ¡†æ¶                        â”‚
â”‚  - æ‰€æœ‰ API æ¥å£                     â”‚
â”‚  - è®¤è¯å’Œæˆæƒ                        â”‚
â”‚  - ä¸šåŠ¡é€»è¾‘                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cloudflare D1â”‚ Cloudflare R2â”‚ Cloudflare KVâ”‚
â”‚  (æ•°æ®åº“)     â”‚  (å¯¹è±¡å­˜å‚¨)   â”‚  (ç¼“å­˜/ä¼šè¯)  â”‚
â”‚  - SQLite    â”‚  - å›¾ç‰‡å­˜å‚¨   â”‚  - Session   â”‚
â”‚  - Drizzle   â”‚  - æ–‡ä»¶å­˜å‚¨   â”‚  - Cache     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—ï¸ æŠ€æœ¯æ ˆ

### å‰ç«¯
- **Cloudflare Pages** - é™æ€ç½‘ç«™æ‰˜ç®¡ + SSR
- **Next.js 14** - React æ¡†æ¶ï¼ˆé€‚é… Pagesï¼‰
- **TypeScript** - ç±»å‹å®‰å…¨
- **Tailwind CSS** - æ ·å¼
- **è‡ªå®šä¹‰ i18n** - å¤šè¯­è¨€æ”¯æŒ

### åç«¯
- **Cloudflare Workers** - è¾¹ç¼˜è®¡ç®—
- **Hono** - è½»é‡çº§ Web æ¡†æ¶
- **Drizzle ORM** - TypeScript ORMï¼ˆæ”¯æŒ D1ï¼‰
- **jose** - JWT å¤„ç†
- **bcryptjs** - å¯†ç å“ˆå¸Œ

### æ•°æ®å±‚
- **Cloudflare D1** - SQLite æ•°æ®åº“
- **Cloudflare R2** - å¯¹è±¡å­˜å‚¨ï¼ˆS3 å…¼å®¹ï¼‰
- **Cloudflare KV** - é”®å€¼å­˜å‚¨
- **Cloudflare Durable Objects** - æœ‰çŠ¶æ€æœåŠ¡ï¼ˆå¯é€‰ï¼‰

### å·¥å…·
- **Wrangler** - Cloudflare CLI
- **Miniflare** - æœ¬åœ°å¼€å‘ç¯å¢ƒ
- **Vitest** - æµ‹è¯•æ¡†æ¶

---

## ğŸ“ é¡¹ç›®ç»“æ„

```
flux-ai/
â”œâ”€â”€ app/                    # Next.js åº”ç”¨ï¼ˆPagesï¼‰
â”‚   â”œâ”€â”€ [locale]/          # å¤šè¯­è¨€è·¯ç”±
â”‚   â””â”€â”€ api/               # API è·¯ç”±ï¼ˆè¿ç§»åˆ° Workersï¼‰
â”œâ”€â”€ worker/                # Cloudflare Workers
â”‚   â”œâ”€â”€ index.ts          # Worker å…¥å£
â”‚   â”œâ”€â”€ routes/           # API è·¯ç”±
â”‚   â”œâ”€â”€ middleware/       # ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ services/         # ä¸šåŠ¡é€»è¾‘
â”‚   â””â”€â”€ db/               # æ•°æ®åº“æ“ä½œ
â”œâ”€â”€ db/                    # æ•°æ®åº“ç›¸å…³
â”‚   â”œâ”€â”€ schema.ts         # Drizzle Schema
â”‚   â”œâ”€â”€ migrations/       # D1 è¿ç§»æ–‡ä»¶
â”‚   â””â”€â”€ seed.ts           # ç§å­æ•°æ®
â”œâ”€â”€ components/            # React ç»„ä»¶
â”œâ”€â”€ lib/                   # å…±äº«åº“
â”œâ”€â”€ public/                # é™æ€èµ„æº
â”œâ”€â”€ wrangler.toml         # Cloudflare é…ç½®
â””â”€â”€ package.json
```

---

## ğŸ”§ å¼€å‘è§„èŒƒ

### 1. æ•°æ®åº“æ“ä½œ

**ä½¿ç”¨ Drizzle ORM**ï¼š

```typescript
// db/schema.ts
import { sqliteTable, text, integer } from 'drizzle-orm/sqlite-core';

export const users = sqliteTable('users', {
  id: text('id').primaryKey(),
  email: text('email').notNull().unique(),
  name: text('name'),
  points: integer('points').default(50),
  createdAt: integer('created_at', { mode: 'timestamp' }).notNull(),
});

// worker/services/userService.ts
import { drizzle } from 'drizzle-orm/d1';
import { users } from '@/db/schema';

export async function getUser(env: Env, userId: string) {
  const db = drizzle(env.DB);
  return await db.select().from(users).where(eq(users.id, userId)).get();
}
```

**âŒ ä¸è¦ä½¿ç”¨ Prisma**ï¼š
```typescript
// âŒ é”™è¯¯ - Prisma ä¸æ”¯æŒ D1
import { prisma } from '@/lib/prisma';
const user = await prisma.user.findUnique({ where: { id: userId } });
```

### 2. API è·¯ç”±

**ä½¿ç”¨ Hono æ¡†æ¶**ï¼š

```typescript
// worker/routes/auth.ts
import { Hono } from 'hono';
import { z } from 'zod';
import { zValidator } from '@hono/zod-validator';

const auth = new Hono<{ Bindings: Env }>();

const loginSchema = z.object({
  email: z.string().email(),
  password: z.string().min(8),
});

auth.post('/login', zValidator('json', loginSchema), async (c) => {
  const { email, password } = c.req.valid('json');
  
  // éªŒè¯ç”¨æˆ·
  const user = await getUserByEmail(c.env, email);
  if (!user || !await verifyPassword(password, user.password)) {
    return c.json({ error: 'Invalid credentials' }, 401);
  }
  
  // ç”Ÿæˆ JWT
  const token = await generateJWT(user);
  
  // å­˜å‚¨ä¼šè¯åˆ° KV
  await c.env.KV.put(`session:${user.id}`, token, { expirationTtl: 86400 });
  
  return c.json({ token, user });
});

export default auth;
```

**âŒ ä¸è¦ä½¿ç”¨ Next.js API Routes**ï¼š
```typescript
// âŒ é”™è¯¯ - Next.js API Routes ä¸é€‚åˆ Workers
export async function POST(req: NextRequest) {
  // ...
}
```

### 3. è®¤è¯ç³»ç»Ÿ

**ä½¿ç”¨ JWT + KV**ï¼š

```typescript
// worker/middleware/auth.ts
import { createMiddleware } from 'hono/factory';
import { jwtVerify } from 'jose';

export const authMiddleware = createMiddleware<{ Bindings: Env }>(async (c, next) => {
  const token = c.req.header('Authorization')?.replace('Bearer ', '');
  
  if (!token) {
    return c.json({ error: 'Unauthorized' }, 401);
  }
  
  try {
    // éªŒè¯ JWT
    const secret = new TextEncoder().encode(c.env.JWT_SECRET);
    const { payload } = await jwtVerify(token, secret);
    
    // æ£€æŸ¥ä¼šè¯æ˜¯å¦å­˜åœ¨
    const session = await c.env.KV.get(`session:${payload.sub}`);
    if (!session) {
      return c.json({ error: 'Session expired' }, 401);
    }
    
    // è®¾ç½®ç”¨æˆ·ä¿¡æ¯åˆ°ä¸Šä¸‹æ–‡
    c.set('userId', payload.sub as string);
    c.set('user', payload);
    
    await next();
  } catch (error) {
    return c.json({ error: 'Invalid token' }, 401);
  }
});
```

**âŒ ä¸è¦ä½¿ç”¨ NextAuth**ï¼š
```typescript
// âŒ é”™è¯¯ - NextAuth éœ€è¦ Node.js runtime
import { auth } from '@/lib/auth';
const session = await auth();
```

### 4. å›¾ç‰‡å­˜å‚¨

**ä½¿ç”¨ Cloudflare R2**ï¼š

```typescript
// worker/services/imageService.ts
export async function uploadImage(
  env: Env,
  imageBuffer: ArrayBuffer,
  filename: string
): Promise<string> {
  // ä¸Šä¼ åˆ° R2
  await env.R2.put(filename, imageBuffer, {
    httpMetadata: {
      contentType: 'image/png',
    },
  });
  
  // è¿”å› CDN URL
  return `https://images.yourdomain.com/${filename}`;
}

export async function getImage(env: Env, filename: string): Promise<Response> {
  const object = await env.R2.get(filename);
  
  if (!object) {
    return new Response('Not found', { status: 404 });
  }
  
  return new Response(object.body, {
    headers: {
      'Content-Type': object.httpMetadata?.contentType || 'image/png',
      'Cache-Control': 'public, max-age=31536000',
    },
  });
}
```

### 5. ç¼“å­˜ç­–ç•¥

**ä½¿ç”¨ Cloudflare KV**ï¼š

```typescript
// worker/services/cacheService.ts
export async function getCached<T>(
  env: Env,
  key: string,
  fetcher: () => Promise<T>,
  ttl: number = 3600
): Promise<T> {
  // å°è¯•ä» KV è¯»å–
  const cached = await env.KV.get(key);
  if (cached) {
    return JSON.parse(cached);
  }
  
  // ç¼“å­˜æœªå‘½ä¸­ï¼Œæ‰§è¡Œ fetcher
  const data = await fetcher();
  
  // å­˜å‚¨åˆ° KV
  await env.KV.put(key, JSON.stringify(data), { expirationTtl: ttl });
  
  return data;
}
```

---

## ğŸš€ éƒ¨ç½²æµç¨‹

### 1. æœ¬åœ°å¼€å‘

```bash
# å®‰è£…ä¾èµ–
npm install

# å¯åŠ¨æœ¬åœ°å¼€å‘æœåŠ¡å™¨
npm run dev

# å¯åŠ¨ Worker æœ¬åœ°å¼€å‘
npm run dev:worker

# è¿è¡Œæ•°æ®åº“è¿ç§»
npm run db:migrate

# ç”Ÿæˆ Drizzle ç±»å‹
npm run db:generate
```

### 2. éƒ¨ç½²åˆ° Cloudflare

```bash
# éƒ¨ç½² Pagesï¼ˆå‰ç«¯ï¼‰
npm run deploy:pages

# éƒ¨ç½² Workersï¼ˆAPIï¼‰
npm run deploy:worker

# è¿è¡Œç”Ÿäº§æ•°æ®åº“è¿ç§»
npm run db:migrate:prod

# éƒ¨ç½²æ‰€æœ‰
npm run deploy
```

### 3. ç¯å¢ƒå˜é‡é…ç½®

```bash
# è®¾ç½® Worker secrets
wrangler secret put JWT_SECRET
wrangler secret put REPLICATE_API_TOKEN
wrangler secret put STRIPE_SECRET_KEY
wrangler secret put GOOGLE_CLIENT_SECRET

# è®¾ç½® KV namespace
wrangler kv:namespace create "KV"
wrangler kv:namespace create "KV" --preview

# è®¾ç½® D1 database
wrangler d1 create flux-ai-db

# è®¾ç½® R2 bucket
wrangler r2 bucket create flux-ai-images
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. è¾¹ç¼˜ç¼“å­˜

```typescript
// ä½¿ç”¨ Cloudflare Cache API
export async function handleRequest(request: Request): Promise<Response> {
  const cache = caches.default;
  const cacheKey = new Request(request.url, request);
  
  // æ£€æŸ¥ç¼“å­˜
  let response = await cache.match(cacheKey);
  
  if (!response) {
    // ç¼“å­˜æœªå‘½ä¸­ï¼Œå¤„ç†è¯·æ±‚
    response = await processRequest(request);
    
    // ç¼“å­˜å“åº”
    const headers = new Headers(response.headers);
    headers.set('Cache-Control', 'public, max-age=3600');
    
    response = new Response(response.body, {
      status: response.status,
      headers,
    });
    
    await cache.put(cacheKey, response.clone());
  }
  
  return response;
}
```

### 2. æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–

```typescript
// ä½¿ç”¨ç´¢å¼•
export const users = sqliteTable('users', {
  id: text('id').primaryKey(),
  email: text('email').notNull().unique(),
  createdAt: integer('created_at', { mode: 'timestamp' }).notNull(),
}, (table) => ({
  emailIdx: index('email_idx').on(table.email),
  createdAtIdx: index('created_at_idx').on(table.createdAt),
}));

// æ‰¹é‡æŸ¥è¯¢
const users = await db.select()
  .from(usersTable)
  .where(inArray(usersTable.id, userIds))
  .all();
```

### 3. å¹¶å‘è¯·æ±‚

```typescript
// ä½¿ç”¨ Promise.all å¹¶å‘æ‰§è¡Œ
const [user, stats, history] = await Promise.all([
  getUser(env, userId),
  getUserStats(env, userId),
  getUserHistory(env, userId),
]);
```

---

## ğŸ”’ å®‰å…¨æœ€ä½³å®è·µ

### 1. ç¯å¢ƒå˜é‡

```typescript
// âœ… æ­£ç¡® - ä½¿ç”¨ Worker secrets
const apiKey = env.REPLICATE_API_TOKEN;

// âŒ é”™è¯¯ - ç¡¬ç¼–ç 
const apiKey = 'sk-xxx';
```

### 2. SQL æ³¨å…¥é˜²æŠ¤

```typescript
// âœ… æ­£ç¡® - ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
const user = await db.select()
  .from(users)
  .where(eq(users.email, email))
  .get();

// âŒ é”™è¯¯ - å­—ç¬¦ä¸²æ‹¼æ¥
const user = await db.run(`SELECT * FROM users WHERE email = '${email}'`);
```

### 3. XSS é˜²æŠ¤

```typescript
// âœ… æ­£ç¡® - è®¾ç½®å®‰å…¨å¤´
return new Response(html, {
  headers: {
    'Content-Type': 'text/html',
    'Content-Security-Policy': "default-src 'self'",
    'X-Content-Type-Options': 'nosniff',
    'X-Frame-Options': 'DENY',
  },
});
```

---

## ğŸ“ è¿ç§»æ£€æŸ¥æ¸…å•

### æ•°æ®åº“
- [ ] å°† Prisma schema è½¬æ¢ä¸º Drizzle schema
- [ ] åˆ›å»º D1 æ•°æ®åº“
- [ ] è¿è¡Œè¿ç§»è„šæœ¬
- [ ] è¿ç§»ç°æœ‰æ•°æ®
- [ ] éªŒè¯æ•°æ®å®Œæ•´æ€§

### è®¤è¯
- [ ] å®ç° JWT è®¤è¯
- [ ] ä½¿ç”¨ KV å­˜å‚¨ä¼šè¯
- [ ] å®ç° OAuth æµç¨‹
- [ ] å®ç°å¯†ç é‡ç½®
- [ ] æµ‹è¯•è®¤è¯æµç¨‹

### API
- [ ] å°†æ‰€æœ‰ API è·¯ç”±è¿ç§»åˆ° Workers
- [ ] ä½¿ç”¨ Hono æ¡†æ¶
- [ ] å®ç°ä¸­é—´ä»¶
- [ ] æ·»åŠ é”™è¯¯å¤„ç†
- [ ] æµ‹è¯•æ‰€æœ‰ API

### å­˜å‚¨
- [ ] åˆ›å»º R2 bucket
- [ ] å®ç°å›¾ç‰‡ä¸Šä¼ 
- [ ] å®ç°å›¾ç‰‡è®¿é—®
- [ ] é…ç½® CDN
- [ ] æµ‹è¯•å›¾ç‰‡åŠŸèƒ½

### å‰ç«¯
- [ ] é€‚é… Cloudflare Pages
- [ ] é…ç½® SSR
- [ ] æ›´æ–° API è°ƒç”¨
- [ ] æµ‹è¯•æ‰€æœ‰é¡µé¢
- [ ] ä¼˜åŒ–æ€§èƒ½

### éƒ¨ç½²
- [ ] é…ç½® wrangler.toml
- [ ] è®¾ç½®ç¯å¢ƒå˜é‡
- [ ] é…ç½® CI/CD
- [ ] éƒ¨ç½²åˆ°é¢„è§ˆç¯å¢ƒ
- [ ] éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

---

## ğŸ¯ æˆåŠŸæ ‡å‡†

1. âœ… 100% éƒ¨ç½²åœ¨ Cloudflare
2. âœ… å…¨çƒå¹³å‡å“åº”æ—¶é—´ < 200ms
3. âœ… æ•°æ®åº“æŸ¥è¯¢ < 50ms
4. âœ… æ‰€æœ‰åŠŸèƒ½æ­£å¸¸
5. âœ… é€šè¿‡æ‰€æœ‰æµ‹è¯•
6. âœ… æˆæœ¬é™ä½ 50%+

---

## ğŸ“š å‚è€ƒèµ„æº

### å®˜æ–¹æ–‡æ¡£
- [Cloudflare Pages](https://developers.cloudflare.com/pages/)
- [Cloudflare Workers](https://developers.cloudflare.com/workers/)
- [Cloudflare D1](https://developers.cloudflare.com/d1/)
- [Cloudflare R2](https://developers.cloudflare.com/r2/)
- [Cloudflare KV](https://developers.cloudflare.com/kv/)
- [Wrangler CLI](https://developers.cloudflare.com/workers/wrangler/)

### æ¡†æ¶å’Œå·¥å…·
- [Hono](https://hono.dev/)
- [Drizzle ORM](https://orm.drizzle.team/)
- [jose (JWT)](https://github.com/panva/jose)

---

**æœ€åæ›´æ–°**: 2024-12-12  
**ç‰ˆæœ¬**: 1.0  
**çŠ¶æ€**: âœ… Cloudflare-First æ¶æ„è§„èŒƒ
